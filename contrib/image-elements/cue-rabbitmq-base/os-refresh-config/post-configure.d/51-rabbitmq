#!/bin/bash
set -eux
set -o pipefail

METADATA_WRITTEN=$(wc -w /var/lib/rabbitmq/.erlang.cookie | awk '{print $1}')
if [ $METADATA_WRITTEN -eq 0 ]; then
    # metadata not written yet
    exit 255
fi

os-svc-enable -n rabbitmq-server
os-svc-restart -n rabbitmq-server

# give rabbit a chance to start
sleep 10

rabbitmqctl stop_app
rabbitmqctl reset

os-svc-restart -n rabbitmq-server

# give rabbitmq a chance to stop/start
sleep 10

# Make sure that all queues (except those with auto-generated names) are
# mirrored across all nodes in the cluster running:
rabbitmqctl set_policy HA '^(?!amq\.).*' '{"ha-mode": "all"}'

echo "RabbitMQ cluster configuration complete..."
